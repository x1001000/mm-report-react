"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,_toPropertyKey(n.key),n)}}function _createClass(e,t,o){return t&&_defineProperties(e.prototype,t),o&&_defineProperties(e,o),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){e=_toPrimitive(e,"string");return"symbol"===_typeof(e)?e:String(e)}function _toPrimitive(e,t){if("object"!==_typeof(e)||null===e)return e;var o=e[Symbol.toPrimitive];if(void 0===o)return("string"===t?String:Number)(e);o=o.call(e,t||"default");if("object"!==_typeof(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}function _classPrivateMethodInitSpec(e,t){_checkPrivateRedeclaration(e,t),t.add(e)}function _checkPrivateRedeclaration(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")}function _classPrivateMethodGet(e,t,o){if(!t.has(e))throw new TypeError("attempted to get private field on non-instance");return o}var _putPurchase=new WeakSet,MCoin=function(){function e(){_classCallCheck(this,e),_classPrivateMethodInitSpec(this,_putPurchase),this.config=void 0,this.emptyModal='\n         <div class="modal fade" data-backdrop="static" data-keyboard="false">\n          <div class="modal-dialog modal-dialog-centered" role="document">\n            <div class="modal-content">\n              <div class="modal-header">\n                <h5 class="modal-title"></h5>\n              </div>\n              <div class="modal-body"></div>\n              <div class="modal-footer">\n                <div>\n                    <button type="button" class="btn btn-light btn-close" data-dismiss="modal"></button>\n                    <button type="button" class="btn btn-primary btn-yes"></button>\n                </div>\n              </div>\n              <div id="video-unused-discount"></div>\n            </div>\n          </div>\n        </div>\n        ',this.modalDOM=$(this.emptyModal),$("body").append(this.modalDOM);var o=this,n=App.__("mcoin:code:empty");$(document).on("click","#btn-video-sure-redeem",function(e){e.preventDefault();var e=$("#video-redeem-code").val(),t=$(this);if(!e)return alertify.alert(n),!1;$.post("/api/video/"+o.config.id+"/redeem",{code:e},function(e){0===e.success?$("#check-redeem-msg").text(e.msg):1===e.success?(alertify.alert(e.msg),location.reload()):2===e.success&&($("#check-redeem-msg").text(App.__("mcoin:discount:pass").jsonFormat({own:e.discount_amount})),$("#video-redeem-code").attr("readonly",!0),t.attr("disabled",!0),o.config.params.discount_id=e.discount_id,o.config.params.code=e.code,o.config.params.discount_amount=e.discount_amount,o.config.params.final_amount=o.config.params.amount-e.discount_amount,$("#final-amount").text(o.config.params.final_amount),$("#discount-wording").text(App.__("mcoin:discount:amount").jsonFormat(o.config.params)),$("#video-unused-discount").empty())})})}return _createClass(e,[{key:"purchase",value:function(e){window.App.isUserLoggedIn()?(this.config=$.extend(!0,{params:{},purchase:function(){},success:function(){},fail:function(){}},e),this.displayPurchaseConfirm()):alertify.reset().alert(App.__("login:msg:pls-login"),function(){location.href="/login?next="+location.pathname})}},{key:"displayPurchaseConfirm",value:function(){var s=this,e=($.get("/source/mcoin/"+this.config.type+"/"+this.config.id,function(e){switch(e.success){case 1:var t,o,n,i,a,c=App.__("mcoin:user:owned:refund"),c=("21"==s.config.type||"22"==s.config.type?App.__("mcoin:user:knowledge_sharing"):"19"===s.config.type?c:App.__("mcoin:user:owned")).jsonFormat(e);"12"===s.config.type?c+='<div style="padding: 10px 15px;"><div class="form-group"><label for="seminar-name">姓名<input class="form-control" type="text" id="seminar-name" value=""/></label></div><div class="form-group"><label for="seminar-email">Email<input class="form-control" type="email" id="seminar-email" value=""/></label></div><div class="form-group"><label for="seminar-phone">手機號<input class="form-control" type="text" id="seminar-phone" value=""/></label></div></div>':"13"===s.config.type&&(t=App.__("mcoin:redeem:sure"),o=App.__("mcoin:code:enter"),n=App.__("mcoin:code:empty"),i="","string"==typeof window.cname_vcode&&$.cookie(window.cname_vcode)&&(a=$.cookie(window.cname_vcode),/^[A-Z0-9]{4,10}$/g.test(a)&&(i=a)),c+='\n                            <div class="pt-3">\n                                <label for="video-redeem-code">'.concat(o,'</label>\n                                <div class="input-group">\n                                    <input type="text" class="form-control" id="video-redeem-code" value="').concat(i,'" autocomplete="off" placeholder="').concat(n,'"/>\n                                    <div class="input-group-append">\n                                        <button id="btn-video-sure-redeem" class="text-right btn btn-secondary">').concat(t,'</button>\n                                    </div>\n                                </div>\n                                \n                                <div class="my-2">\n                                    <p id="check-redeem-msg" class="text-danger small"></p>\n                                </div>\n                            </div>    \n                            ')),c+=App.__("mcoin:agreement:title"),s.modalDOM.find("div.modal-body").html(c),"13"===s.config.type&&(s.config.params.amount=parseInt(e.amount));break;case 0:s.displayModal(function(){window.open(e.link)});break;default:alert(e.message)}}),App.__("common:btn:redeem")),t=("13"===this.config.type?(this.modalDOM.find(".video-redeem-input-div").empty(),this.modalDOM.find(".video-redeem-btn-div").empty().append('<a id="btn-video-show-redeem" style="cursor: pointer;"><u>'+App.__("mcoin:use_discount:btn")+"</u></a>"),e=App.__("mcoin:discount:redeem")):"21"!==this.config.type&&"22"!==this.config.type&&"19"!==this.config.type||(e=App.__("common:btn:sure")),App.__("mcoin:process:tip"));"19"===this.config.type&&(t=App.__("mcoin:process:refund")),this.displayModal(t,'<div class="align-center"><img src="/img/ui/ajax-loader-fb-50e3c2.gif"/></div>',e,App.__("common:btn:cancel"),function(){if("12"===this.config.type){var e=$("#seminar-name").val(),t=$("#seminar-email").val(),o=$("#seminar-phone").val();if(""===e.trim()||e.length<2)return alert("請輸入正確姓名"),!1;if(-1===t.search(/^[^\[\]\(\)\\<>:;,@.]+[^\[\]\(\)\\<>:;,@]*@[a-z0-9A-Z]+(([.]?[a-z0-9A-Z]+)*[-]*)*[.]([a-z0-9A-Z]+[-]*)+$/))return alert("請輸入正確Email"),!1;if(!/^09\d{8}$/.test(o))return alert("請輸入正確手機號"),!1;this.config.params.u_name=e,this.config.params.u_email=t,this.config.params.u_phone=o}return this.modalDOM.find("input[type=checkbox]").prop("checked")?_classPrivateMethodGet(this,_putPurchase,_putPurchase2).call(this):(alert(App.__("mcoin:agreement:unchecked")),!1)},function(){"21"==this.config.type&&$.post("/question/delete",{id:this.config.id},function(e){}),"22"==this.config.type&&(this.config.fail.call(this,null),$.post("/answer/delete",{id:this.config.id},function(e){}))})}},{key:"displayModal",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"",t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"",o=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"Yes",n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:"Cancel",i=4<arguments.length?arguments[4]:void 0,a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:void 0,e=("13"===this.config.type&&$("#video-unused-discount").empty(),this.modalDOM.find("h5").html(e),this.modalDOM.find("div.modal-body").html(t),this.modalDOM.find("button.btn-yes").hide()),c=(void 0!==o&&0<o.length&&e.html(o).show(),void 0!==n&&0<n.length&&this.modalDOM.find("button.btn-close").hide().html(n).show(),""==n&&this.modalDOM.find("button.btn-close").hide(),this);this.modalDOM.off("click","button.btn-close").off("click","button.btn-yes").on("click","button.btn-yes",function(){void 0!==i&&!1===i.call(c)||c.modalDOM.modal("hide")}).on("click","button.btn-close",function(){null!=a&&!1===a.call(c)||c.modalDOM.modal("hide")}).modal()}}]),e}();function _putPurchase2(){var n=this;if(n.config.hasOwnProperty("type")&&"13"===n.config.type){var e=$("#video-redeem-code").val();if(""!==e.trim()&&!n.config.params.hasOwnProperty("discount_id"))return $("#video-unused-discount").html('<p class="mb-0 pl-3 text-danger">'+App.__("mcoin:code:unused")+"</p>"),!1;App.trk4("video_mcoin_payment_1",{promo_code:""!==e.trim()})}this.modalDOM.one("hidden.bs.modal",function(){n.modalDOM.find(".video-redeem-btn-div").empty(),n.modalDOM.find(".video-redeem-input-div").empty(),$.post("/source/mcoin/"+n.config.type+"/"+n.config.id,n.config.params,function(e){var t=void 0;switch(e.success){case 1:n.config.success.call(n,e),n.modalDOM.one("hidden.bs.modal",function(){if("21"==n.config.type||"22"==n.config.type)return!1;void 0!==n.config.refer?location.href=n.config.refer:location.reload()});var o={11:"pro",13:"video",15:"monthly",16:"prime",17:"max",21:"question",22:"ask-again"};try{App.trk4("mcoins_redeem",{item_id:("string"==typeof o[n.config.type]?o[n.config.type]:"obj"+n.config.type)+"-"+n.config.id,amount:n.config.params.amount})}catch(e){}switch(n.config.type){case"15":n.displayModal(App.__("mcoin:code:redeem_ok"),e.message,App.__("btn:go-read"),App.__("common:btn:cancel"),function(){location.href="/mails/monthly_report"});break;case"13":n.displayModal(App.__("mcoin:code:redeem_ok"),e.message,"OK",App.__("common:btn:cancel"),function(){App.trk4("video_mcoin_payment_successful"),App.trk4("choose_video_payment",{payment:"M-coin"})});break;case"21":case"22":break;default:n.displayModal(App.__("mcoin:code:redeem_ok"),e.message,"OK",App.__("common:btn:cancel"))}break;case-1:t=e.link;case 0:n.config.fail.call(n,e),n.displayModal(e.title,e.message,e.button,App.__("common:btn:cancel"),function(){"13"==n.config.type&&App.trk4("video_mcoin_payment_2"),location.href=t});break;default:alert(e.message)}})}).modal("hide")}$(function(){var t=new MCoin;window.manualPurchase=function(e){t.purchase(e)},$("[role=mcoin-purchase]").on("click",function(){var e=this.dataset;void 0!==e.type&&void 0!==e.rel&&t.purchase({type:e.type,id:e.rel})})});